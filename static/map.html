<!DOCTYPE html>
<html lang="en">
<head>
<script type="text/javascript" src="static/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="static/heatmap.js"></script>
<script type="text/javascript" src="static/heatmap-gmaps.js"></script>
<script type="text/javascript" src="static/ring-buffer.js"></script>
<script type="text/javascript">
window.onload = function(){
    // standard gmaps initialization
    var myLatlng = new google.maps.LatLng(53, -8);
    // define map properties
    var myOptions = {
      zoom: 6,
      center: myLatlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI: false,
      scrollwheel: false,
      draggable: false,
      navigationControl: false,
      mapTypeControl: false,
      scaleControl: false,
      disableDoubleClickZoom: true
    };
    var map = new google.maps.Map($("#heatmap")[0], myOptions);
    var heatmap = new HeatmapOverlay(map, {
        "radius":10,
        "visible":true, 
        "opacity":100,
        "gradient": { 0.0: "blue", 1.0: "red" }
    });

 
    var initial_data={ max: 100, data: [] };
    google.maps.event.addListener(map, "idle", function(){ heatmap.setDataSet(initial_data); });
 
 	var ringbuf = new RingBuffer(initial_data['max']);
 	var reported = false;
 	var evtSource = new EventSource("/tweets");
    evtSource.onmessage = function(message) {
    	var tweet = JSON.parse(message.data);
    	//$('#tweets').append('<li>' + tweet['text'] + '</li>');
    	for (var i = 0; i < ringbuf.length; ++i) {
			ringbuf.get(i)['count'] -= initial_data['max'] / ringbuf.capacity;
    	}
    	var data_point = {lat: tweet['coordinates'][1], lng: tweet['coordinates'][0], count: 100};
    	//console.log(data_point['lat'], data_point['lng'], data_point['count']);
    	ringbuf.push(data_point);
    	/*if (ringbuf.length == 100 && !reported) {
    		reported = true;
    		console.log('Mapped 100 tweets');
    	}
    	console.log(ringbuf.length);*/
    	var data={ max: 100, data: ringbuf.get_array() };
    	heatmap.setDataSet(data);
	}
};
</script>
</head>
<body>
	<p>A heat map of latest tweets in Ireland. First time it gets a tweet it sets it a max temperature and then slowly cools it down as it fetches more tweets.</p>
	<div id="heatmap" class="well" style="width:610px;padding:0;height:400px;position:relative;"></div>
	<ul id="tweets"></ul>
</body>
</html>